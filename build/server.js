// Generated by CoffeeScript 1.8.0
(function() {
  var DESTINATION_FOLDER, app, bodyParser, cors, express, format, fs, libmime, magic, mmm, request, savefile;

  DESTINATION_FOLDER = '/home/will/Music/downloads';

  express = require('express');

  bodyParser = require('body-parser');

  cors = require('cors');

  request = require('superagent');

  fs = require('fs');

  mmm = require('mmmagic');

  magic = new mmm.Magic(mmm.MAGIC_MIME_TYPE);

  libmime = require('libmime');

  app = express();

  app.use(bodyParser.json());

  app.use(cors());

  format = function(path, cb) {
    return magic.detectFile(path, function(err, result) {
      var extension;
      if (err) {
        throw err;
      }
      extension = libmime.detectExtension(result);
      return cb(extension);
    });
  };

  savefile = function(_arg, resp) {
    var artist, dest, filename, name, url;
    artist = _arg.artist, name = _arg.name, url = _arg.url;
    filename = "" + name + " -- " + artist;
    dest = "" + DESTINATION_FOLDER + "/" + filename;
    console.log('requesting', url);
    return request.get(url).set('Accept-Encoding', 'gzip,deflate,sdch').set('Connection', 'keep-alive').end(function(err, res) {
      if (err || res.status > 399) {
        console.error(res.status);
        console.log('Error retrieving file');
        return resp.send('');
      }
      res.pipe(fs.createWriteStream(dest));
      return res.on('end', function() {
        return format(dest, function(ext) {
          var finalPath;
          finalPath = "" + dest + "." + ext;
          return fs.rename(dest, finalPath, function() {
            console.log("'" + filename + "." + ext + "' <= '" + url + "'");
            return resp.send('');
          });
        });
      });
    });
  };

  app.post('/save', function(req, resp) {
    var artist, name, url, _ref;
    _ref = req.body, artist = _ref.artist, name = _ref.name, url = _ref.url;
    return savefile({
      artist: artist,
      name: name,
      url: url
    }, resp);
  });

  app.listen(7777);

  console.log('Listening on port 7777');

}).call(this);
